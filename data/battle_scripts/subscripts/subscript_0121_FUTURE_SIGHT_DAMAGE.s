.include "asm/include/battle_commands.inc"

.data

_Start:
    PrintBufferedMessage 
    Wait 
    WaitButtonABTime 30
    CheckMoveHit BATTLER_CATEGORY_MSG_ATTACKER, BATTLER_CATEGORY_MSG_TEMP, BATTLER_CATEGORY_MSG_TEMP, _MoveFailed
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MOVE_EFFECT_CHANCE, 1
    PlayMoveAnimationOnMons BATTLER_CATEGORY_MSG_TEMP, BATTLER_CATEGORY_MSG_ATTACKER, BATTLER_CATEGORY_MSG_TEMP
    Wait
    // Always play the Future Sight animation.
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_BATTLE_STATUS, BATTLE_STATUS_MOVE_ANIMATIONS_OFF
    CompareMonDataToValue OPCODE_FLAG_NOT, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_STATUS2, STATUS2_SUBSTITUTE, _Hit
    UpdateVar OPCODE_MUL, BSCRIPT_VAR_HP_CALC, -1
    // Check if we have broken the substitute.
    CompareMonDataToVar OPCODE_LTE, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_SUBSTITUTE_HP, BSCRIPT_VAR_HP_CALC, _BreakSubstitute
    // If not, deplete the substitute's HP.
    UpdateMonDataFromVar OPCODE_SUB, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_SUBSTITUTE_HP, BSCRIPT_VAR_HP_CALC
    GoTo _SubstituteCleanup

_BreakSubstitute:
    UpdateMonData OPCODE_SET, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_SUBSTITUTE_HP, 0
    UpdateMonData OPCODE_FLAG_OFF, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_STATUS2, STATUS2_SUBSTITUTE

_SubstituteCleanup:
    Call BATTLE_SUBSCRIPT_HIT_SUBSTITUTE
    GoTo _CheckIfEndured

_Hit:
    CheckHoldOnWith1HP BATTLER_CATEGORY_MSG_TEMP
    Call BATTLE_SUBSCRIPT_UPDATE_HP
    // Check if Rage needs to be updated.
    CompareMonDataToValue OPCODE_FLAG_NOT, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_STATUS2, STATUS2_RAGE, _CheckIfEndured
    CompareMonDataToValue OPCODE_EQU, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_HP, 0, _CheckIfEndured
    CompareMonDataToValue OPCODE_EQU, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_STAT_CHANGE_ATK, 12, _CheckIfEndured
    UpdateMonData OPCODE_ADD, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_STAT_CHANGE_ATK, 1
    PlayBattleAnimation BATTLER_CATEGORY_MSG_TEMP, BATTLE_ANIMATION_STAT_BOOST
    Wait
    // {0}â€™s rage is building!
    PrintMessage 363, TAG_NICKNAME, BATTLER_CATEGORY_MSG_TEMP
    Wait 
    WaitButtonABTime 30

_CheckIfEndured:
    CompareVarToValue OPCODE_FLAG_NOT, BSCRIPT_VAR_MOVE_STATUS_FLAGS, MOVE_STATUS_ENDURED_ITEM, _Cleanup
    CompareMonDataToValue OPCODE_EQU, BATTLER_CATEGORY_MSG_TEMP, BMON_DATA_ABILITY, ABILITY_STURDY, _Cleanup
    PlayBattleAnimation BATTLER_CATEGORY_MSG_TEMP, BATTLE_ANIMATION_HELD_ITEM
    Wait 
    // {0} hung on using its {1}!
    PrintMessage 912, TAG_NICKNAME_ITEM, BATTLER_CATEGORY_MSG_TEMP, BATTLER_CATEGORY_MSG_BATTLER_TEMP
    Wait 
    WaitButtonABTime 30
    // Ensure the held item is a Focus Sash (HOLD_EFFECT_ENDURE) and not a Focus Band (HOLD_EFFECT_ENDURE_MAYBE).
    CheckItemHoldEffect CHECK_OPCODE_NOT_HAVE, BATTLER_CATEGORY_MSG_TEMP, HOLD_EFFECT_ENDURE, _End
    RemoveItem BATTLER_CATEGORY_MSG_TEMP

_Cleanup:
    UpdateVarFromVar OPCODE_SET, BSCRIPT_VAR_BATTLER_TARGET, BSCRIPT_VAR_MSG_BATTLER_TEMP
    UpdateVarFromVar OPCODE_SET, BSCRIPT_VAR_BATTLER_ATTACKER, BSCRIPT_VAR_MSG_ATTACKER
    UpdateVarFromVar OPCODE_SET, BSCRIPT_VAR_PHYSICAL_DAMAGE_TAKEN, BSCRIPT_VAR_HP_CALC // Allows Color Change to proc.
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MOVE_NO_CUR, MOVE_FUTURE_SIGHT
    TriggerAbilityOnHit _End
    CallFromVar BSCRIPT_VAR_TEMP_DATA
    Call BATTLE_SUBSCRIPT_SWITCH_IN_ABILITY_CHECK

_End:
    End 

_MoveFailed:
    WaitButtonABTime 30
    // But it failed!
    PrintMessage 796, TAG_NONE
    Wait 
    WaitButtonABTime 30
    End 
