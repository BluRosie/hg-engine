.include "asm/include/battle_commands.inc"

.data

// Updated to clear terrains and such.
_Start:
    // Check if any condition is met for Defog to clear.
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_REFLECT_TURNS, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_LIGHT_SCREEN_TURNS, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_AURORA_VEIL_TURNS, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_MIST_TURNS, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_SAFEGUARD_TURNS, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_SPIKES_LAYERS, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_TOXIC_SPIKES_LAYERS, _PlayMoveAndAnim
    CompareVarToValue OPCODE_FLAG_SET, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_STEALTH_ROCKS, _PlayMoveAndAnim
    CompareVarToValue OPCODE_FLAG_SET, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_STICKY_WEB, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_ATTACKER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_SPIKES_LAYERS, _PlayMoveAndAnim
    CheckSideCondition BATTLER_CATEGORY_ATTACKER, CHECK_SIDE_COND_VAL_NOT_ZERO, SIDE_COND_TOXIC_SPIKES_LAYERS, _PlayMoveAndAnim
    CompareVarToValue OPCODE_FLAG_SET, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_STEALTH_ROCKS, _PlayMoveAndAnim
    CompareVarToValue OPCODE_FLAG_SET, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_STICKY_WEB, _PlayMoveAndAnim
    CompareVarToValue OPCODE_FLAG_SET, BSCRIPT_VAR_FIELD_CONDITION, FIELD_CONDITION_FOG, _PlayMoveAndAnim
    GotoIfTerrainOverlayIsType GRASSY_TERRAIN, _PlayMoveAndAnim
    GotoIfTerrainOverlayIsType MISTY_TERRAIN, _PlayMoveAndAnim
    GotoIfTerrainOverlayIsType ELECTRIC_TERRAIN, _PlayMoveAndAnim
    GotoIfTerrainOverlayIsType PSYCHIC_TERRAIN, _PlayMoveAndAnim
    // If no conditions are cleared, skip the attack animation (?)
    GoTo _LowerEvasion

_PlayMoveAndAnim:
    Call BATTLE_SUBSCRIPT_ATTACK_MESSAGE_AND_ANIMATION

_LowerEvasion:
    UpdateVar OPCODE_SET, BSCRIPT_VAR_SIDE_EFFECT_PARAM, MOVE_SUBSCRIPT_PTR_EVASION_DOWN_1_STAGE
    Call BATTLE_SUBSCRIPT_UPDATE_STAT_STAGE
    // Clear Reflect (if it is active).
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_REFLECT_TURNS, _ClearLightScreen
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_CLEAR, SIDE_COND_REFLECT_TURNS, _ClearLightScreen
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_REFLECT
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearLightScreen:
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_LIGHT_SCREEN_TURNS, _ClearAuroraVeil
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_CLEAR, SIDE_COND_LIGHT_SCREEN_TURNS, _ClearAuroraVeil
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_LIGHT_SCREEN
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearAuroraVeil:
    CompareVarToValue OPCODE_FLAG_NOT, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_AURORA_VEIL, _ClearMist
    ClearAuroraVeil
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_AURORA_VEIL
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearMist:
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_MIST_TURNS, _ClearSafeguard
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_CLEAR, SIDE_COND_MIST_TURNS, _ClearSafeguard
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_MIST
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearSafeguard:
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_SAFEGUARD_TURNS, _ClearSpikes
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_CLEAR, SIDE_COND_SAFEGUARD_TURNS, _ClearSpikes
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_SAFEGUARD
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearSpikes:
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_SPIKES_LAYERS, _ClearPlayerSpikes
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_CLEAR, SIDE_COND_SPIKES_LAYERS, _ClearPlayerSpikes
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_SPIKES
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_DEFENDER, HAZARD_IDX_SPIKES
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_SPIKES
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearPlayerSpikes:
    CheckSideCondition BATTLER_CATEGORY_ATTACKER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_SPIKES_LAYERS, _ClearToxicSpikes
    CheckSideCondition BATTLER_CATEGORY_ATTACKER, CHECK_SIDE_COND_CLEAR, SIDE_COND_SPIKES_LAYERS, _ClearToxicSpikes
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_SPIKES
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_ATTACKER, HAZARD_IDX_SPIKES
    // If the message has already been printed, do not print it again.
    CompareVarToValue OPCODE_EQU, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_SPIKES, _ClearToxicSpikes
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_SPIKES
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearToxicSpikes:
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_TOXIC_SPIKES_LAYERS, _ClearPlayerToxicSpikes
    CheckSideCondition BATTLER_CATEGORY_DEFENDER, CHECK_SIDE_COND_CLEAR, SIDE_COND_TOXIC_SPIKES_LAYERS, _ClearPlayerToxicSpikes
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_TOXIC_SPIKES
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_ATTACKER, HAZARD_IDX_TOXIC_SPIKES
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_TOXIC_SPIKES
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearPlayerToxicSpikes:
    CheckSideCondition BATTLER_CATEGORY_ATTACKER, CHECK_SIDE_COND_VAL_ZERO, SIDE_COND_TOXIC_SPIKES_LAYERS, _ClearStealthRock
    CheckSideCondition BATTLER_CATEGORY_ATTACKER, CHECK_SIDE_COND_CLEAR, SIDE_COND_TOXIC_SPIKES_LAYERS, _ClearStealthRock
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_TOXIC_SPIKES
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_ATTACKER, HAZARD_IDX_TOXIC_SPIKES
    // If the message has already been printed, do not print it again.
    CompareVarToValue OPCODE_EQU, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_TOXIC_SPIKES, _ClearStealthRock
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_TOXIC_SPIKES
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearStealthRock:
    CompareVarToValue OPCODE_FLAG_NOT, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_STEALTH_ROCKS, _ClearPlayerStealthRock
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_STEALTH_ROCKS
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_ATTACKER, HAZARD_IDX_STEALTH_ROCK
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_STEALTH_ROCK
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearPlayerStealthRock:
    CompareVarToValue OPCODE_FLAG_NOT, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_STEALTH_ROCKS, _ClearStickyWeb
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_STEALTH_ROCKS
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_ATTACKER, HAZARD_IDX_STEALTH_ROCK
    // If the message has already been printed, do not print it again.
    CompareVarToValue OPCODE_EQU, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_STEALTH_ROCK, _ClearStickyWeb
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_STEALTH_ROCK
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearStickyWeb:
    CompareVarToValue OPCODE_FLAG_NOT, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_STICKY_WEB, _ClearPlayerStickyWeb
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_TARGET, SIDE_CONDITION_STICKY_WEB
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_ATTACKER, HAZARD_IDX_STICKY_WEB
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_STICKY_WEB
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearPlayerStickyWeb:
    CompareVarToValue OPCODE_FLAG_NOT, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_STICKY_WEB, _ClearTerrain
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_SIDE_CONDITION_ATTACKER, SIDE_CONDITION_STICKY_WEB
    RemoveEntryHazardFromQueue BATTLER_CATEGORY_ATTACKER, HAZARD_IDX_STICKY_WEB
    // If the message has already been printed, do not print it again.
    CompareVarToValue OPCODE_EQU, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_STICKY_WEB, _ClearTerrain
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_STICKY_WEB
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearTerrain:
    GotoIfTerrainOverlayIsType GRASSY_TERRAIN, _ClearGrassyTerrain
    GotoIfTerrainOverlayIsType MISTY_TERRAIN, _ClearMistyTerrain
    GotoIfTerrainOverlayIsType ELECTRIC_TERRAIN, _ClearElectricTerrain
    GotoIfTerrainOverlayIsType PSYCHIC_TERRAIN, _ClearPsychicTerrain
    GoTo _ClearFog

_ClearGrassyTerrain:
    UpdateTerrainOverlay TRUE, _ClearFog
    ChangePermanentBackground BATTLE_BG_CURRENT, TERRAIN_CURRENT
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_GRASSY_TERRAIN
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE
    GoTo _ClearFog

_ClearMistyTerrain:
    UpdateTerrainOverlay TRUE, _ClearFog
    ChangePermanentBackground BATTLE_BG_CURRENT, TERRAIN_CURRENT
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_MISTY_TERRAIN
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE
    GoTo _ClearFog

_ClearElectricTerrain:
    UpdateTerrainOverlay TRUE, _ClearFog
    ChangePermanentBackground BATTLE_BG_CURRENT, TERRAIN_CURRENT
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_ELECTRIC_TERRAIN
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE
    GoTo _ClearFog

_ClearPsychicTerrain:
    UpdateTerrainOverlay TRUE, _ClearFog
    ChangePermanentBackground BATTLE_BG_CURRENT, TERRAIN_CURRENT
    UpdateVar OPCODE_SET, BSCRIPT_VAR_MSG_MOVE_TEMP, MOVE_PSYCHIC_TERRAIN
    Call BATTLE_SUBSCRIPT_DEFOG_MESSAGE

_ClearFog:
    CompareVarToValue OPCODE_FLAG_NOT, BSCRIPT_VAR_FIELD_CONDITION, FIELD_CONDITION_FOG, _End
    UpdateVar OPCODE_FLAG_OFF, BSCRIPT_VAR_FIELD_CONDITION, FIELD_CONDITION_FOG
    // {0} blew away the deep fog with {1}!
    PrintMessage 1045, TAG_NICKNAME_MOVE, BATTLER_CATEGORY_ATTACKER, BATTLER_CATEGORY_ATTACKER
    Wait 
    WaitButtonABTime 30

_End:
    End 
